name: Check DB

on:
  pull_request:
    branches:
      - main
  schedule:
    # We want to run right after the `latest` image is published.
    # So, let's do it an hour right after. Look the schedule of publishing here:
    # https://github.com/alexhumphreys/idris2-dockerfile/blob/main/.github/workflows/docker-image.yml
    - cron: '0 1 * * *'

defaults:
  run:
    shell: bash

jobs:

  build:
    name: Run installation script
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Install scheme
        run: sudo apt-get update && sudo apt-get install --yes gcc make chezscheme libgmp3-dev
      - name: Run installation script
        run: echo chezscheme | bash install.bash
      - name: Install pack-admin
        run: $HOME/.pack/bin/pack install-app pack-admin
      - name: Extract DB from HEAD
        run: $HOME/.pack/bin/pack-admin extract-from-head $HOME/.pack/db/testdb.toml
      - name: Check DB
        run: $HOME/.pack/bin/pack-admin check-collection testdb
